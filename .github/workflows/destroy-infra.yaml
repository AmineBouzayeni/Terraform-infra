name: Terraform Infra Destroy workflow
run-name: Terraform Infra Destroy CI
on:
  schedule:
    - cron: '30 17 * * *' 
env:
  CLUSTER_NAME: dockercoins-cluster-teo
  CLUSTER_ZONE: europe-west1-b
  PROJECT_NAME: teolia-school-devops

jobs:
    deleteGKEIngressInfra:
      name: Destroy GKE ingress infra(Ingress, LB, NEG & Certificate which blocks vpc destruction)
      runs-on: ubuntu-latest
      steps:
        - name: Checkout code
          uses: actions/checkout@master
          with:
            repository: 'AmineBouzayeni/DockerCoinsApp'
            ref: 'feature/abouzayeni/TA-19'
        - name: Install gcloud authentication plugin
          run: |
            REPO_URL="https://packages.cloud.google.com/apt"
            echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] $REPO_URL cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list >/dev/null
            curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -
      
            sudo apt-get update -y
            sudo apt-get install -y google-cloud-sdk-gke-gcloud-auth-plugin
      
        - name: Authenticate to Google Cloud
          uses: 'google-github-actions/auth@v1'
          with:
            credentials_json: '${{ secrets.GCLOUD_KEY }}'
            token_format: 'access_token'
          
        - name: Authenticate to GKE cluster
          run: |   
            gcloud container clusters get-credentials \
            ${{ env.CLUSTER_NAME }} --zone ${{ env.CLUSTER_ZONE }} --project ${{ env.PROJECT_NAME }}    
        
        - name: Destroy Ingress Infra
          run: |
            if [[ $(kubectl get ingress -n app | grep -c managed-cert-ingress) == 0 ]]
              then
                echo "No ingress resource in app namespace. Skipping."
            else    
              kubectl delete -f manifests/prod/ingress-manifest.yml
            fi  

    destroyInfra:
        name: Destroy Infra
        runs-on: ubuntu-latest
        needs: [deleteGKEIngressInfra]
        steps:
            - name: Checkout code
              uses: actions/checkout@master
            - name: Setup Terragrunt
              uses: autero1/action-terragrunt@v1.1.0
              with:
                terragrunt_version: "latest"
                token: ${{ secrets.GITHUB_TOKEN }}
            - name: Configure credentials for Service Account.
              env: 
                KEY: ${{ secrets.ADMIN_SA_KEY }}
              run: |
                mkdir auth
                echo "$KEY" > auth/admin-sa-sa.json
            - name: Destroy devops service account
              run: |
                cd implementations/service_account
                terragrunt init && terragrunt destroy -auto-approve
              env:
                GOOGLE_CREDENTIALS: ${{ secrets.ADMIN_SA_KEY }}  # Backend credentials
            - name: Configure credentials for Kubernetes Cluster Deployment.
              env:
                KEY: ${{ secrets.COMPUTE_ENGINE_SA_KEY }}
              run: |
                echo "$KEY" > auth/compute-engine-sa.json
            - name: Destroy kubernetes cluster infra
              run: |
                cd implementations/kube-cluster-infra
                terragrunt init && terragrunt destroy -auto-approve
              env:
                GOOGLE_CREDENTIALS: ${{ secrets.COMPUTE_ENGINE_SA_KEY }}  # Backend credentials
